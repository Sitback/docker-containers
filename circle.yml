machine:
  ruby:
    version: 2.1.0
  services:
    - docker

# Thanks to http://disq.us/8oltdg
checkout:
  post:
    # Set all files have a mtime of 2014-01-01.
    - find . -exec touch -t 201401010000 {} \;
    # Set all tracked files to have a mtime as per git.
    - for x in $(git ls-tree --full-tree --name-only -r HEAD);\
      do touch -t \
      $(date -d "$(git log -1 --format=%ci "${x}")" +%y%m%d%H%M.%S) \
      "${x}"; done

dependencies:
  cache_directories:
    - ~/docker
  post:
    - mkdir -p ~/docker
    - ls -al ~/docker/
    - bundle exec rake docker:ci_build

test:
  override:
    - bundle exec rake docker:test:_circleci_parallel:
        parallel: true

deployment:
  hub:
    branch: master
    commands:
      - bundle exec rake docker:publish
